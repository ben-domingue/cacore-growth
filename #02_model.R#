##need to get reliabilities
##residualize
##step 2
##step 3

load("_ela.Rdata")

vx<-var(df$scale_score,na.rm=TRUE)
##reliability<-vx/(vx+var(df$standard_error_measurement,na.rm=TRUE))
reliabity<-0.9
library(mecor)

ids<-sample(unique(df$school_code),100)
df<-df[df$school_code %in% ids,]

z<-df[,c("school_code","scale_score","lag_scale_score")]
df0<-df[rowSums(is.na(z))==0,] #just for analysis

##step 1
##school matrix
ids<-unique(df0$school_code)
for (id in ids) df0[[paste("schoolid_",id,sep='')]]<-as.numeric(df0$school_code==id)
    
##Additionally, all models control for disability, English language learner, economic disadvantage, foster care, and homelessness statuses at the student level. 
fm.base<-~+#disability
                                        #ell
    core_sd+core_fst+core_hmls
for (nm in all.vars(fm.base)) df0[[nm]]<-factor(df0[[nm]],exclude=NULL)
                                               
#m<-lm(scale_score~lag_scale_score+factor(school_code),df0)
ii<-grep("^schoolid",names(df0))
#fm<-paste("scale_score~lag_scale_score+",paste(names(df0)[ii],collapse='+'),sep='')
#lm(as.formula(fm),df0)
ii<-ii[-1] #to ensure no collinearity problem
fm<-paste("scale_score~MeasErrorRandom(lag_scale_score,var(lag_scale_score,na.rm=TRUE)*(1-reliability))+",paste(names(df0)[ii],collapse='+'),sep='')
m1<-mecor(as.formula(fm),df0)
#coef(m)[2]
#m1$corfit$coef[2]


